+++
title = "Ускоряем генерацию Open Graph изображений на Rust"
date = "2024-10-25"
draft = true

[taxonomies]
tags = ["Rust", "Блог"]

[extra]
comment = true
toc = true
og_image = "og-image.jpeg"
+++

Я уже говорил, что решение по генерации изображений для соцсетей из прошлой [статьи](/posts/ogimages-rust) неидеально &mdash; оно требует установленного Google Chrome, запускает его, ждёт пока страница загрузится и потом делает скриншот.

Во второй части этого цикла статей я покажу, как у меня получилось улучшить производительность и удобство своего приложения для генерации OG Image, а ещё добавить автоматическую генерацию этих изображений при публикации нового черновика.

<!--more-->

# Зачем я отказался от браузера и шаблонов?

Сам по себе шаблонизатор неплох, он работает быстро и отлично решает свою задачу, но вот превратить созданный им HTML в изображение без браузера никак. А вот с ним уже есть проблемы:

1. Для работы необходим установленный Google Chrome, который есть не всегда, или установить его нет возможности (например, на CI-серверах);
2. Отсюда невозможность автоматизации запуска (например при публикации нового черновика);
3. Хотя браузер запускается в headless режиме, почему-то при использовании `chromiumoxide` всё равно появляется белое окно, которое ничего не отображает, но всё равно висит всё время генерации;
4. Для того, чтобы загрузились все необходимые ресурсы и страница полностью срендерилась, нужно некоторое время, которое зависит от производительности компьютера. Так в моих условиях это примерно 600 миллисекунд на изображение. Да, это не очень много, но всё равно мешает.

Поэтому неплохо бы найти другое, более удачное решение

# Как работает SVG?

В прошлой статье я упоминал, что кроме браузера можно генерировать SVG, как делает, например `@vercel/og`. SVG &mdash; это растровый формат изображений, который оперирует примитивами, например полигонами и определяет их положение в сетке координат. Но что более важно, так это то, что SVG &mdash; текстовый формат, основанный на XML, а значит, его можно легко создавать программно.

# Как должно работать всё приложение?

Примерно так выглядит базовая структура проекта на Zola:

```
.
└─── content
     ├─── _index.md
     └─── posts
          ├─── _index.md
          └─── better-ogimages-rust
               └─── index.md
```

В корне лежит конфиг, который управляет настройками сайта, папка `contents` &mdash; это стартовая директория для содержимого сайта. `posts` &mdash; это коллекция с постами, таких может быть несколько. Генерировать изображения я хочу для всех постов во всех коллекциях, значит, нужно предусмотреть способ передавать снаружи список коллекций для генерации. Причём это параметр опциональный, со значением по умолчанию `posts`

Собрав список публикаций, достанем из них преамбулу (TOML-часть в начале каждой статьи), распарсим её в структуру (об этом было [в предыдущей статье](/posts/ogimages-rust/#kod)).

Получив все необходимые данные, можно приступать к генерации SVG. Нам нужен довольно небольшой функционал &mdash; вставка текста, прямоугольника, группы и CSS-стилей. Добавим немного математики, чтобы правильно спозиционировать элементы на холсте.

Собрав такой SVG-файл мы его распарсим и отрендерим в PNG, положим рядом с MD-файлом статьи и удалим сохранённый ранее SVG.

Готово. Полученный файл можно добавить в meta тег.
