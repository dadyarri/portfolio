---
title: "Эволюция генератора Open Graph изображений на C#"
date: "2025-06-28"
draft: true
tags: ["csharp", "blog"]
series: "ogimages"

---

[Мигрировав](/posts/yet-another-migration) сайт обратно на Astro, я рассчитывал использовать механику интеграций для генерации Open Graph изображений. И хотя локально это работало, на продакшн сервере интеграция просто молча игнорировалась. Так что пришлось возвращаться к хранению изображений в репозитории. Для этого я написал новую утилиту, но уже на C#.

<!--more-->

Пока сайт работал на Zola, я писал утилиту генерации изображений на Rust. После нескольких итераций удалось собрать рабочий инструмент, который быстро создавал изображения по дизайну из конфигурационного TOML-файла.

Впоследствии даже появилась мысль интегрировать это решение в Zola, но для этого мне пришлось бы перелопатить половину весьма запутанной кодовой базы этого генератора.

Но одновременно изучать сильно отличающийся от привычного мне язык и погружаться в весьма запутанную кодовую базу генератора оказалось слишком сложно и заняло бы слишком много времени, большая часть из которого ушла бы на борьбу с компилятором и странными ошибками, объяснения которым я найти не смог. Возможно, дело в каких-то глубинных особенностях работы на Windows.

Затем я начал упираться в возможности Zola с точки зрения фронтенда — шаблоны постепенно разрастались и поддерживать их становилось всё сложнее. Поэтому я начал миграцию сайта обратно на Astro — фреймворк, на котором сайт работал в прошлую свою итерацию. Я рассчитывал на то, что генерацию превью можно будет возложить на встроенный в него механизм интеграций.

Перенеся сайт, я смог заставить работать интеграцию для генерации превью. Но первый же деплой сайта на Netlify показал, что этот механизм нежизнеспособен — интеграция просто игнорировалась. Я тогда не стал разбираться с причинами, но предположил, что дело было в ограничении на создание файлов из пользовательского кода.

Но поскольку необходимость в инструменте так и не отпала — Astro, несмотря на свою гибкость и универсальность, не даёт возможности генерировать изображения для превью во время сборки, я решил вернуться к старому варианту с хранением изображений в репозитории и обеспечить их генерацию перед сборкой сайта на Netlify через Github Actions.

На этот раз я решил не экспериментировать и взять для этой итерации генератора свой основной инструмент — **.NET**.

Вместе с переездом на новую платформу инструмент претерпел множество функциональных изменений:

- Во-первых, я не стал сохранять старый формат конфигурации (в формате TOML), а использовал более нативный для .NET JSON.
- Во-вторых, ушла привязка к конкретному фреймворку сайта — все необходимые директории, откуда нужно брать файлы статей, и куда сохранять готовые изображения — легко настраивается прямо из конфига
- В-третьих, я отказался от генерации SVG-изображений перед созданием финальных PNG. Оказывается на .NET есть весьма качественная кроссплатформенная (что для меня достаточно важно) библиотека для рисования изображений напрямую `SixLabors.ImageSharp`. Перед созданием прошлой Rust-итерации я был уверен, что существует только виндовая `System.Drawing`, поэтому даже не рассматривал .NET для этого проекта.

# API

Как и в Rust итерации, новый инструмент - это консольное приложение, которое запускается из Github Actions во время пуша в ветку master. Оно обновляет превью статей, используя файл конфигурации и от имени бота коммитит изменения в репозиторий. 

```yaml
- name: Set up Dotnet
  uses: actions/setup-dotnet@v4
  with:
    dotnet-version: '9.0.x'

- name: Build OgImages
  run: |
    dotnet publish OgImages/OgImages/OgImages.csproj -r linux-x64 -c Release

- name: Generate OG image for merged content
  run: |
    chmod +x ./OgImages/OgImages/bin/Release/net9.0/linux-x64/OgImages
    ./OgImages/OgImages/bin/Release/net9.0/linux-x64/OgImages --all

- name: Commit and push new OG images
  run: |
    if [[ -n $(git status --porcelain) ]]; then
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "updated og-images"
        git push
    else
        echo "No changes to commit"
    fi
```

Отличие состоит в том, что в прошлой версии исполняемые файлы хранились прямо в репозитории. Это означало, что при изменении исходников мне приходилось не только коммитить их, но и вручную пересобирать исполняемые файлы, а затем также добавлять их в репозиторий. Теперь же приложение собирается каждый раз при запуске генерации (что, впрочем, происходит нечасто). Собранное приложение в репозиторий при этом не попадает.